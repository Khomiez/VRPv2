# อัลกอริทึมการหาคำตอบ VRP Solver v2

## 1. ภาพรวมของปัญหา

ปัญหา Vehicle Routing Problem (VRP) ในระบบนี้คือการหาเส้นทางที่เหมาะสมที่สุดสำหรับรถเก็บขยะ โดยมีเงื่อนไขดังนี้:

- **จุดเริ่มต้นและสิ้นสุด**: Node 1 (จุดจอดรถ)
- **จุดทิ้งขยะ**: ต้องผ่านก่อนกลับ Node 1
- **ความจุรถ**: ขยะทั่วไป 2,000 หน่วย, ขยะ recycle 200 หน่วย
- **เป้าหมาย**: ลดต้นทุนรวมให้น้อยที่สุด

## 2. โครงสร้างเส้นทางที่ถูกต้อง

```
Node 1 (เก็บขยะ) --> จุดเก็บขยะต่างๆ --> จุดทิ้ง --> Node 1 (ไม่เก็บขยะ)
```

### กฎสำคัญ:
1. เริ่มต้นที่ Node 1 และเก็บขยะที่ Node 1 ทันที
2. เดินทางไปเก็บขยะตามจุดต่างๆ
3. **ต้อง**ผ่านจุดทิ้งขยะก่อนกลับ Node 1
4. กลับมาที่ Node 1 โดยไม่เก็บขยะซ้ำ

## 3. อัลกอริทึมที่ใช้

### 3.1 Google OR-Tools (หลัก)

ระบบใช้ **Google OR-Tools** ซึ่งเป็น library สำหรับแก้ปัญหา optimization โดยมีขั้นตอนดังนี้:

#### ขั้นตอนที่ 1: สร้างโมเดล
```
1. กำหนด Node 1 เป็น depot (จุดเริ่มต้น/สิ้นสุด)
2. สร้าง distance matrix จากข้อมูล Excel
3. กำหนด demand ของแต่ละ node
4. กำหนด capacity constraints ของรถ
```

#### ขั้นตอนที่ 2: First Solution Strategy
ใช้วิธี **PATH_CHEAPEST_ARC** ในการหาคำตอบเริ่มต้น:
- เริ่มจาก depot
- เลือก node ถัดไปที่มีระยะทางน้อยที่สุด
- ทำซ้ำจนครบทุก node

#### ขั้นตอนที่ 3: Local Search Metaheuristic
ใช้ **GUIDED_LOCAL_SEARCH** ในการปรับปรุงคำตอบ:
- ทดลองสลับลำดับ node ในเส้นทาง
- ทดลองย้าย node ระหว่างเส้นทาง
- เก็บคำตอบที่ดีที่สุดที่พบ

#### ขั้นตอนที่ 4: Post-Processing (เพิ่มจุดทิ้ง)
```
สำหรับแต่ละเส้นทาง:
    1. นำผลลัพธ์จาก OR-Tools
    2. แทรกจุดทิ้งก่อน node สุดท้าย (depot)
    3. คำนวณระยะทางใหม่
```

### 3.2 Nearest Neighbor Heuristic (สำรอง)

หาก OR-Tools ไม่สามารถหาคำตอบได้ ระบบจะใช้วิธี Nearest Neighbor:

```
1. เริ่มที่ Node 1
2. เลือก node ที่ใกล้ที่สุดที่ยังไม่ได้เยี่ยม
3. ตรวจสอบว่า capacity เพียงพอหรือไม่
4. ถ้าเพียงพอ -> ไปยัง node นั้น
5. ถ้าไม่เพียงพอ -> ไปจุดทิ้ง แล้วกลับ depot
6. ทำซ้ำจนครบทุก node
```

## 4. การคำนวณต้นทุน

### สูตรการคำนวณ

```
ต้นทุนรวม = ต้นทุนคงที่ + ต้นทุนน้ำมัน

โดยที่:
- ต้นทุนคงที่ = จำนวนรถ x 2,400 บาท/คัน
- ต้นทุนน้ำมัน = ระยะทาง(กม.) x อัตราน้ำมัน(บาท/กม.)
```

### การแปลงหน่วยระยะทาง

```
ระยะทาง (กิโลเมตร) = ระยะทาง (เมตร) / 1,000
```

**ตัวอย่าง:**
- ระยะทาง: 5,298 เมตร = 5.298 กิโลเมตร
- อัตราน้ำมัน: 8 บาท/กม.
- ต้นทุนน้ำมัน: 5.298 x 8 = 42.38 บาท
- ต้นทุนคงที่: 2,400 บาท
- **ต้นทุนรวม: 2,442.38 บาท**

## 5. Capacity Constraints

### ข้อจำกัดความจุ

| ประเภท | ความจุสูงสุด |
|--------|-------------|
| ขยะทั่วไป | 2,000 หน่วย |
| ขยะ Recycle | 200 หน่วย |

### การตรวจสอบ

```python
ถ้า (ขยะทั่วไปในรถ + ขยะใหม่ > 2,000) หรือ
   (ขยะ recycle ในรถ + recycle ใหม่ > 200):
    -> ต้องใช้รถคันใหม่
```

## 6. การตรวจสอบความถูกต้อง (Validation)

ระบบตรวจสอบคำตอบตามเงื่อนไขต่อไปนี้:

| เงื่อนไข | คำอธิบาย |
|---------|---------|
| เริ่มที่ Node 1 | ทุกเส้นทางต้องเริ่มจาก Node 1 |
| ผ่านจุดทิ้ง | ต้องผ่านจุดทิ้งก่อนกลับ Node 1 |
| สิ้นสุดที่ Node 1 | ทุกเส้นทางต้องจบที่ Node 1 |
| ไม่ซ้ำ node | แต่ละ node ถูกเยี่ยมได้ครั้งเดียว |
| ไม่เกิน capacity | น้ำหนักรวมไม่เกินความจุรถ |
| ครบทุก node | ทุก node ต้องถูกเยี่ยม |

## 7. ข้อมูล Input

### โครงสร้างข้อมูลจาก Excel

```
- Destination: หมายเลข node
- Origin_1 ถึง Origin_N: ระยะทางระหว่าง node (เมตร)
- ขยะทั่วไป: ปริมาณขยะทั่วไป หรือ "จุดทิ้ง"
- ขยะ recycle: ปริมาณขยะ recycle
- รถคันที่: ประเภทรถ (A, B, C)
- cap for general: ความจุขยะทั่วไป (2,000)
- cap for recycle: ความจุขยะ recycle (200)
- fix cost: ต้นทุนคงที่ (2,400 บาท)
- variable cost: ต้นทุนน้ำมัน (8-9 บาท/กม.)
```

## 8. ข้อมูล Output

### โครงสร้างผลลัพธ์ JSON

```json
{
  "status": "OPTIMAL",
  "num_vehicles_used": 1,
  "total_distance_km": 5.298,
  "total_cost": 2442.38,
  "routes": [
    {
      "vehicle_id": 1,
      "route": [1, 2, 3, ..., 20, 1],
      "distance_km": 5.298,
      "general_load": 588,
      "recycle_load": 44,
      "total_cost": 2442.38
    }
  ]
}
```

## 9. ความซับซ้อนของอัลกอริทึม

| ขนาดปัญหา | จำนวน Node | เวลาประมวลผล |
|-----------|-----------|-------------|
| เล็ก | 20-30 | < 5 วินาที |
| กลาง | 50-80 | 5-20 วินาที |
| ใหญ่ | 138 | 30-60 วินาที |

## 10. สรุป

อัลกอริทึมนี้ใช้ OR-Tools ซึ่งเป็นเครื่องมือที่มีประสิทธิภาพสูงในการแก้ปัญหา VRP โดยมีขั้นตอนหลักดังนี้:

1. **สร้างโมเดล**: กำหนด depot, distance matrix, demands, capacities
2. **หาคำตอบเริ่มต้น**: ใช้ PATH_CHEAPEST_ARC
3. **ปรับปรุงคำตอบ**: ใช้ GUIDED_LOCAL_SEARCH
4. **เพิ่มจุดทิ้ง**: Post-processing เพื่อให้ตรงตามเงื่อนไข
5. **ตรวจสอบ**: Validation เพื่อยืนยันความถูกต้อง

ผลลัพธ์ที่ได้คือเส้นทางที่มีต้นทุนต่ำที่สุด โดยเป็นไปตามเงื่อนไขทั้งหมดที่กำหนด
